<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezerwacja Terminów</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Firebase konfiguracja
            const firebaseConfig = {
                apiKey: "AIzaSyAeWykrY_aL427Q-aFLOs-K0GOBgmGhEgs",
                authDomain: "projekt-rezerwacja.firebaseapp.com",
                projectId: "projekt-rezerwacja",
                storageBucket: "projekt-rezerwacja.appspot.com",
                messagingSenderId: "118180989579",
                appId: "1:118180989579:web:dd3e4487c40d0b3863628e",
                measurementId: "G-KBZ1VVJ9QH"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            emailjs.init("xqyVbSjeXibISoZml");

            // Funkcja do ładowania dostępnych terminów
            function loadAvailableSlots() {
                db.collection("availableSlots").where("booked", "==", false).onSnapshot(snapshot => {
                    const slotsContainer = document.getElementById("availableSlots");
                    slotsContainer.innerHTML = "";
                    snapshot.forEach(doc => {
                        const slot = doc.data();
                        const option = document.createElement("option");
                        option.value = doc.id;
                        option.textContent = `${slot.date} - ${slot.startTime} do ${slot.endTime}`;
                        slotsContainer.appendChild(option);
                    });
                });
            }
            loadAvailableSlots();

            // Obsługa rezerwacji
            document.getElementById("bookingForm").addEventListener("submit", function(event) {
                event.preventDefault();

                const meetingType = document.getElementById("meetingType").value;
                const name = document.getElementById("name").value;
                const email = document.getElementById("email").value;
                const weddingDate = document.getElementById("weddingDate").value;
                const weddingPlace = document.getElementById("weddingPlace").value;
                const services = document.getElementById("services").value;
                const message = document.getElementById("message").value;
                const slotId = document.getElementById("availableSlots").value;
                const selectedSlot = document.querySelector(`#availableSlots option[value="${slotId}"]`).textContent;

                const bookingData = {
                    meetingType,
                    name,
                    email,
                    weddingDate,
                    weddingPlace,
                    services,
                    message,
                    slotId,
                    selectedSlot,
                    bookedAt: new Date().toISOString()
                };

                db.collection("bookings").add(bookingData)
                .then(() => {
                    db.collection("availableSlots").doc(slotId).update({ booked: true });

                    // Powiadomienie e-mail przez EmailJS (Naprawione)
                    emailjs.send("service_f8ccgjc", "template_8x51wzj", {
                        to_email: "projektweselelubuskie@gmail.com",
                        user_name: name,
                        user_email: email,
                        wedding_date: weddingDate,
                        wedding_place: weddingPlace,
                        selected_slot: selectedSlot,
                        services: services || "Brak usługodawców",
                        message: message || "Brak dodatkowej wiadomości"
                    }).then(() => {
                        alert("Rezerwacja zapisana i e-mail wysłany!");
                        document.getElementById("bookingForm").reset();
                        loadAvailableSlots();
                    }).catch(error => {
                        console.error("Błąd wysyłania e-maila:", error);
                        alert("Rezerwacja zapisana, ale wystąpił błąd przy wysyłce e-maila.");
                    });
                })
                .catch(error => {
                    console.error("Błąd zapisu rezerwacji:", error);
                });
            });
        });
    </script>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 600px;
            margin: 30px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            text-align: left;
            color: #333;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            color: #333;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Rezerwacja Spotkania</h2>
        <form id="bookingForm">
            <label for="meetingType">Rodzaj spotkania:</label>
            <select id="meetingType" required>
                <option value="online">Online</option>
                <option value="biuro">W biurze</option>
            </select>
            <label for="name">Imię i nazwisko:</label>
            <input type="text" id="name" required>
            <label for="email">E-mail:</label>
            <input type="email" id="email" required>
            <label for="weddingDate">Data wesela:</label>
            <input type="date" id="weddingDate" required>
            <label for="weddingPlace">Miejsce wesela:</label>
            <input type="text" id="weddingPlace" required>
            <label for="services">Usługodawcy:</label>
            <input type="text" id="services" placeholder="Wpisz usługodawców">
            <label for="message">Dodatkowa wiadomość:</label>
            <textarea id="message" placeholder="Wpisz dodatkowe informacje"></textarea>
            <label for="availableSlots">Wybierz dostępny termin:</label>
            <select id="availableSlots" required></select>
            <button type="submit">Zarezerwuj</button>
        </form>
    </div>
</body>
</html>
