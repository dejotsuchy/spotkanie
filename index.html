document.addEventListener("DOMContentLoaded", function () {
    // Firebase konfiguracja
    const firebaseConfig = {
        apiKey: "AIzaSyAeWykrY_aL427Q-aFLOs-K0GOBgmGhEgs",
        authDomain: "projekt-rezerwacja.firebaseapp.com",
        projectId: "projekt-rezerwacja",
        storageBucket: "projekt-rezerwacja.appspot.com",
        messagingSenderId: "118180989579",
        appId: "1:118180989579:web:dd3e4487c40d0b3863628e",
        measurementId: "G-KBZ1VVJ9QH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    emailjs.init("xqyVbSjeXibISoZml");

    // Funkcja dzieląca przedział na 1-godzinne sloty
    function splitIntoHourlySlots(date, startTime, endTime) {
        let slots = [];
        let start = new Date(`${date}T${startTime}`);
        let end = new Date(`${date}T${endTime}`);

        while (start < end) {
            let nextHour = new Date(start);
            nextHour.setHours(nextHour.getHours() + 1);

            if (nextHour > end) break; // Zapobiega przekraczaniu końca przedziału

            slots.push({
                date: date,
                startTime: start.toTimeString().substring(0, 5), // Format HH:MM
                endTime: nextHour.toTimeString().substring(0, 5),
                booked: false
            });

            start = nextHour; // Przesunięcie do następnej godziny
        }

        return slots;
    }

    // Dodawanie dostępnych godzinnych terminów
    document.getElementById("adminForm").addEventListener("submit", function(event) {
        event.preventDefault();
        const date = document.getElementById("adminDate").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;

        const slots = splitIntoHourlySlots(date, startTime, endTime);
        
        // Dodanie podzielonych slotów do Firestore
        let batch = db.batch();
        slots.forEach(slot => {
            let docRef = db.collection("availableSlots").doc(); // Tworzy nowy dokument dla każdego slotu
            batch.set(docRef, slot);
        });

        batch.commit().then(() => {
            alert("Dostępne godziny zostały dodane.");
        });
    });

    // Pobieranie dostępnych terminów
    function loadAvailableSlots() {
        db.collection("availableSlots").where("booked", "==", false).onSnapshot(snapshot => {
            const slotsContainer = document.getElementById("availableSlots");
            slotsContainer.innerHTML = "";
            snapshot.forEach(doc => {
                const slot = doc.data();
                const option = document.createElement("option");
                option.value = doc.id;
                option.textContent = `${slot.date} - ${slot.startTime} do ${slot.endTime}`;
                slotsContainer.appendChild(option);
            });
        });
    }
    
    loadAvailableSlots();
});
