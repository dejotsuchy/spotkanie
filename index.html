<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezerwacja Terminów</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Konfiguracja Firebase
            const firebaseConfig = {
                apiKey: "YOUR_FIREBASE_API_KEY",
                authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
                projectId: "YOUR_FIREBASE_PROJECT_ID",
                storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
                messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
                appId: "YOUR_FIREBASE_APP_ID",
                measurementId: "YOUR_FIREBASE_MEASUREMENT_ID"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // Inicjalizacja EmailJS
            emailjs.init("xqyVbSjeXibISoZml");

            // Funkcja dzieląca czas na godzinne sloty
            function splitIntoHourlySlots(date, startTime, endTime) {
                let slots = [];
                let start = new Date(`${date}T${startTime}`);
                let end = new Date(`${date}T${endTime}`);

                while (start < end) {
                    let nextHour = new Date(start);
                    nextHour.setHours(nextHour.getHours() + 1);
                    if (nextHour > end) break;

                    slots.push({
                        date: date,
                        startTime: start.toTimeString().substring(0, 5),
                        endTime: nextHour.toTimeString().substring(0, 5),
                        booked: false
                    });

                    start = nextHour;
                }
                return slots;
            }

            // Obsługa formularza administratora
            document.getElementById("adminForm").addEventListener("submit", function(event) {
                event.preventDefault();
                const date = document.getElementById("adminDate").value;
                const startTime = document.getElementById("startTime").value;
                const endTime = document.getElementById("endTime").value;
                const slots = splitIntoHourlySlots(date, startTime, endTime);
                
                let batch = db.batch();
                slots.forEach(slot => {
                    let docRef = db.collection("availableSlots").doc();
                    batch.set(docRef, slot);
                });
                batch.commit().then(() => {
                    alert("Dostępne godziny zostały dodane.");
                });
            });

            // Ładowanie dostępnych terminów
            function loadAvailableSlots() {
                db.collection("availableSlots").where("booked", "==", false).onSnapshot(snapshot => {
                    const slotsContainer = document.getElementById("availableSlots");
                    slotsContainer.innerHTML = "";
                    snapshot.forEach(doc => {
                        const slot = doc.data();
                        const option = document.createElement("option");
                        option.value = doc.id;
                        option.textContent = `${slot.date} - ${slot.startTime} do ${slot.endTime}`;
                        slotsContainer.appendChild(option);
                    });
                });
            }
            loadAvailableSlots();

            // Obsługa formularza rezerwacji
            document.getElementById("bookingForm").addEventListener("submit", function(event) {
                event.preventDefault();

                // Pobranie wartości z formularza
                const meetingType = document.getElementById("meetingType").value;
                const name = document.getElementById("name").value;
                const email = document.getElementById("email").value;
                const weddingDate = document.getElementById("weddingDate").value;
                const weddingPlace = document.getElementById("weddingPlace").value;
                const services = document.getElementById("services").value;
                const message = document.getElementById("message").value;
                const slotId = document.getElementById("availableSlots").value;

                // Pobranie wybranego slotu z Firestore
                db.collection("availableSlots").doc(slotId).get().then(doc => {
                    if (doc.exists) {
                        const slot = doc.data();

                        // Przygotowanie parametrów dla EmailJS
                        const templateParams = {
                            to_email: "projektweselelubuskie@gmail.com",
                            from_name: name,
                            from_email: email,
                            meeting_type: meetingType,
                            wedding_date: weddingDate,
                            wedding_place: weddingPlace,
                            services: services,
                            message: message,
                            reservation_date: slot.date,
                            reservation_start_time: slot.startTime,
                            reservation_end_time: slot.endTime
                        };

                        // Wysłanie e-maila za pomocą EmailJS
                        emailjs.send('service_f8ccgjc', 'template_8x51wzj', templateParams)
                            .then(function(response) {
                                alert('Rezerwacja została pomyślnie wysłana!');
                                // Zaktualizuj status slotu na "booked"
                                db.collection("availableSlots").doc(slotId).update({ booked: true });
                            }, function(error) {
                                alert('Wystąpił błąd podczas wysyłania rezerwacji: ' + JSON.stringify(error));
                            });
                    } else {
                        alert("Wybrany termin nie jest już dostępny.");
                    }
                }).catch(function(error) {
                    console.error("Błąd podczas pobierania terminu: ", error);
                });
            });
        });
    </script>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #121212;
            color: #d4af37;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 600px;
            margin: 30px auto;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            text-align: left;
            color: #fff;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #d4af37;
            border-radius: 5px;
            background
::contentReference[oaicite:0]{index=0}
 
